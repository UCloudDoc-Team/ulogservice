# 多行完全正则提取模式采集日志

## 背景信息

ULogAgent 通过多行完全正则模式采集日志时，以指定的首行正则匹配多行日志的第一行，以指定的正则表达式提取日志内容（Value），您需要为每个 Value 指定自定义的字段名（Key），从而实现日志数据的结构化处理。如果您需要结构化处理多行文本日志，建议使用多行完全正则模式。

## 操作步骤

### 步骤1：创建/选择日志主题
参考主题、主题集管理

### 步骤2：采集配置

#### 配置日志文件采集路径
![文本路径](/images/text/text_path_1.png)
**文件路径**即日志所在的目录和文件名，ULogAgent 会按照采集路径中的目录部分匹配符合规则的目录，监听这些目录下符合规则的日志文件。最多设置 10 个不同的采集路径。
采集路径可以指定完整的目录和文件名，也可以通过通配符模糊匹配。

常见的采集路径的配置方式及示例如下。

| 配置方式       | 目录前缀表达式 | 文件名表达式 | 说明                                                         |
| -------------- | -------------- | ------------ | ------------------------------------------------------------ |
| 完整文件名称   | /var/log/nginx | access.log   | 此例中，日志文件路径配置为`/var/log/nginx/**/access.log`，ULogAgent 将会监听`/var/log/nginx`前缀路径下所有子目录中以`access.log`命名的日志文件 |
| 文件名后缀匹配 | /var/log/nginx | *.log        | 此例中，日志文件路径配置为`/var/log/nginx/**/*.log`，ULogAgent 将会监听`/var/log/nginx`前缀路径下所有子目录中以`.log`结尾的日志文件 |
| 文件名模糊匹配 | /var/log/nginx | error*       | 此例中，日志文件路径配置为`/var/log/nginx/**/error*`，ULogAgent 将会监听`/var/log/nginx`前缀路径下所有子目录中以`error`开头命名的日志文件 |

#### 配置采集策略
- 全量：ULogAgent 采集文件时，从文件的开头开始读。
- 增量：ULogAgent 采集文件时，只采集文件内新增的内容。

#### 配置编码模式
- UTF-8：若您的日志文件编码模式为 UTF-8，请选择该选项。
- GBK：若您的日志文件编码模式为 GBK，请选择该选项。

#### 配置单行完全正则模式

1. 在采集配置页面，将“提取模式”设置为多行完全正则，并在“日志样例”文本框中，输入日志样例。如下图所示
![文本路径](/images/text/text_multi_line_fullregex_1.png)

2. 输入行首正则表达式，单击验证，系统将判断表达式是否通过。如下图所示：
![文本路径](/images/text/text_multi_line_fullregex_2.png)

3. 直接手动输入表达式，提取并验证 key-value。如下图所示：
![文本路径](/images/text/text_multi_line_fullregex_3.png)

#### 上传解析失败日志
是否上传解析失败的日志，默认为开启状态。
- 开启：所有解析失败的日志，均以指定字段作为键名称（Key），原始日志内容作为值（Value）上传到日志服务。其中键名称可以通过失败日志键名称指定，默认为 LogParseFailure。
- 关闭：解析失败的日志不上传到日志服务。
![文本路径](/images/text/text_logParseFailure_1.png)

- 确认采集配置，并单击完成创建。

### 步骤3：索引配置
![文本路径](/images/text/text_index_1.png)